Bootstrap: docker
From: nvidia/cuda:12.9.1-cudnn-devel-ubuntu22.04

%files
    BindCraft /BindCraft

%environment
    export PATH=/opt/miniconda/envs/BindCraft/bin:$PATH
    export CONDA_PREFIX=/opt/miniconda/envs/BindCraft
    export LD_LIBRARY_PATH=/opt/miniconda/envs/BindCraft/lib:$LD_LIBRARY_PATH
    export PYTHONNOUSERSITE=1

%post
    chmod 777 /tmp
    echo "[INFO] Updating apt cache"
    apt-get update || true
    apt-get install -y \
        libglib2.0-0 \
        ca-certificates \
        wget \
        git \
        tar \
        bzip2 || true

    echo "[INFO] Installing Miniconda"
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/miniconda
    rm /tmp/miniconda.sh
    export PATH=/opt/miniconda/bin:$PATH

    conda config --system --set always_yes yes
    conda config --system --remove channels defaults || true
    conda config --system --add channels conda-forge
    conda config --system --add channels https://conda.graylab.jhu.edu

    cd /BindCraft

    bash install_bindcraft.sh

    cd ..

    echo "[INFO] Cleaning up"
    conda clean -afy

